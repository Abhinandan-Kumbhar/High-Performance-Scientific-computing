clear all;
close all;
K=load("KG.txt");
M=load("MG.txt");
dt=0.00001;
format long;
T=0.0008;
t=[0:dt:T];
w=20000;
[phi,lambda]=eigs(K,M,10,"smallestabs");
f=zeros(500,1);
f(90)=5e10;
f(441)=5e10;
k=phi'*M*phi;
EV=inv(sqrt(k))*phi';
EV=EV';
F=EV'*f;
tmat=zeros(10,size(t,2));
for i=[1:10]
for j=[1:size(t,2)]
  tmat(i,j)=(w*sin(sqrt(lambda(i,i))*t(j))-sqrt(lambda(i,i))*sin(w*t(j)))/sqrt(lambda(i,i))/(w^2-lambda(i,i));
end
end
q=diag(F)*tmat;
u=EV*q;
figure();
plot(t,u(90,:),'linewidth',2);
hold on;
% u(89,:) copied from terminal
uh1=[0.00000000 0.00011571 0.00091767 0.00305257 0.00708986 0.01348765 0.02256397 0.03447463 0.04919881 0.06653321 0.08609503 0.10733385 0.12955193 0.15193212 0.17357235 0.19352510 0.21084018 0.22460910 0.23400885 0.23834330 0.23708023 0.22988234 0.21663063 0.19743903 0.17265948 0.14287688 0.10889405 0.07170697 0.03247122 -0.00753923 -0.04697933 -0.08448436 -0.11872375 -0.14845468 -0.17257363 -0.19016349 -0.20053427 -0.20325566 -0.19817984 -0.18545356 -0.16551862 -0.13910068 -0.10718643 -0.07099011 -0.03191011 0.00852236 0.04870088 0.08700556 0.12186622 0.15182495 0.17559513 0.19211487 0.20059238 0.20054154 0.19180599 0.17457067 0.14936010 0.11702335 0.07870593 0.03580966 -0.01005817 -0.05714458 -0.10361723 -0.14763511 -0.18742059 -0.22133026 -0.24792171 -0.26601361 -0.27473664 -0.27357326 -0.26238451 -0.24142267 -0.21132917 -0.17311740 -0.12814120 -0.07804972 -0.02473031 0.02975841 0.08326121 0.13360554];
uh=[0.00000000 0.00011583 0.00091860 0.00305567 0.00709701 0.01350118 0.02258644 0.03450864 0.04924681 0.06659727 0.08617665 0.10743376 0.12966995 0.15206706 0.17372194 0.19368597 0.21100797 0.22477850 0.23417381 0.23849724 0.23721632 0.22999375 0.21671086 0.19748223 0.17266075 0.14283256 0.10880194 0.07156657 0.03228381 -0.00777051 -0.04724946 -0.08478660 -0.11904975 -0.14879478 -0.17291716 -0.19049912 -0.20085047 -0.20354112 -0.19842393 -0.18564678 -0.16565302 -0.13917022 -0.10718735 -0.07092109 -0.03177247 0.00872463 0.04896120 0.08731486 0.12221328 0.15219671 0.17597716 0.19249186 0.20094872 0.20086190 0.19207594 0.17477726 0.14949239 0.11707289 0.07866719 0.03568029 -0.01027715 -0.05744868 -0.10399862 -0.14808281 -0.18792079 -0.22186679 -0.24847657 -0.26656763 -0.27527018 -0.27406695 -0.26281997 -0.24178328 -0.21160070 -0.17328865 -0.12820450 -0.07800127 -0.02457048 0.03002503 0.08362584 0.13405551]; 
plot(t(1:end-1),uh1,'r--','linewidth',2);
legend({'GMAM response by matlab code','GMAM response by C code (parallel)'},'Location','southwest')
title('Response of node 90 by MDM')
xlabel('Time in seconds') 
ylabel('displacement of node 90')
grid on;
grid minor;
figure();
size(u)
size(uh)
plot(t(1:end-1),(u(90,1:end-1)-uh1),'linewidth',2);
hold on;
plot(t(1:end-1),(u(90,1:end-1)-uh),'r--','linewidth',2);
legend({'Error using 250 iterations of QR algorithm','Error using 500 iterations of QR algorithm'},'Location','southwest')
title('Error in prediction of response of node 90 by MDM')
xlabel('Time in seconds') 
ylabel('Error in displacement of node 90')
grid on;
grid minor;